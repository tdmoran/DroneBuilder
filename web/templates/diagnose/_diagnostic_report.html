<article>
  <header>
    <strong>Diagnostic Report — {{ report.build_name }}</strong>
    <br><small>{{ report.fc_info }}</small>
  </header>

  {# Config changes since last backup #}
  {% if report.config_changes is not none %}
  <div id="config-changes-area">
    {% if report.config_changes %}
    <details>
      <summary>Config changes since last backup: <strong>{{ report.config_changes | length }} setting{{ 's' if report.config_changes | length != 1 }} changed</strong></summary>
      <ul>
        {% for change in report.config_changes %}
        <li><small>{{ change }}</small></li>
        {% endfor %}
      </ul>
    </details>
    {% else %}
    <p><small>No config changes since last backup.</small></p>
    {% endif %}
  </div>
  {% endif %}

  {# Overall status #}
  {% if report.has_critical_issues %}
  <div style="border-left: 4px solid #ff4136; padding: 0.5rem 0.75rem; margin-bottom: 1rem;">
    <strong style="color: #ff4136;">Critical issues found</strong>
    — {{ report.discrepancies | selectattr('severity.value', 'equalto', 'critical') | list | length +
         (report.firmware_report.critical_failures | length if report.firmware_report else 0) +
         (report.compatibility_report.critical_failures | length if report.compatibility_report else 0) }} critical
  </div>
  {% else %}
  <div style="border-left: 4px solid #2ecc40; padding: 0.5rem 0.75rem; margin-bottom: 1rem;">
    <strong style="color: #2ecc40;">No critical issues</strong>
  </div>
  {% endif %}

  {# Symptom-relevant findings #}
  {% if report.symptoms and report.symptom_relevant %}
  <div class="validation-section critical" style="border-color: #9b59b6;">
    <strong style="color: #9b59b6;">Related to:
      {% for s in report.symptoms %}
        "{{ symptoms.get(s, s) }}"{% if not loop.last %}, {% endif %}
      {% endfor %}
    </strong>

    {% for item in report.symptom_relevant %}
    <div class="validation-item diagnostic-finding">
      <span class="severity-{{ item.severity.value }}">
        {% if item.severity.value == 'critical' %}&#10007;{% elif item.severity.value == 'warning' %}&#9888;{% else %}&#8505;{% endif %}
        {{ item.severity.value | upper }}
      </span>
      {% if item.constraint_id is defined %}
      <strong>{{ item.constraint_id }}</strong>: {{ item.constraint_name }}
      <br><small>{{ item.message }}</small>
      {% if fix_suggestions.get(item.constraint_id) %}
      <details>
        <summary><small>How to fix</small></summary>
        <p><small>{{ fix_suggestions[item.constraint_id] }}</small></p>
      </details>
      {% endif %}
      {% else %}
      <strong>{{ item.id }}</strong>: {{ item.component_type | capitalize }} discrepancy
      <br><small>{{ item.message }}</small>
      <details>
        <summary><small>How to fix</small></summary>
        <p><small>{{ item.fix_suggestion }}</small></p>
      </details>
      {% endif %}
      <span class="badge" style="font-size: 0.7em; background: #9b59b6; color: #fff;">symptom match</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {# Other findings #}
  {% set other = report.other_findings %}
  {% if other %}
  <h4>Other Findings</h4>

  {# Group by severity #}
  {% set critical_items = other | selectattr('severity.value', 'equalto', 'critical') | list %}
  {% set warning_items = other | selectattr('severity.value', 'equalto', 'warning') | list %}
  {% set info_items = other | selectattr('severity.value', 'equalto', 'info') | list %}

  {% if critical_items %}
  <div class="validation-section critical">
    <strong class="severity-critical">Critical</strong>
    {% for item in critical_items %}
    <div class="validation-item diagnostic-finding">
      {% if item.constraint_id is defined %}
      <strong>{{ item.constraint_id }}</strong>: {{ item.constraint_name }}
      <br><small>{{ item.message }}</small>
      {% if fix_suggestions.get(item.constraint_id) %}
      <details>
        <summary><small>How to fix</small></summary>
        <p><small>{{ fix_suggestions[item.constraint_id] }}</small></p>
      </details>
      {% endif %}
      {% else %}
      <strong>{{ item.id }}</strong>: {{ item.component_type | capitalize }} discrepancy
      <br><small>{{ item.message }}</small>
      <details>
        <summary><small>How to fix</small></summary>
        <p><small>{{ item.fix_suggestion }}</small></p>
      </details>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if warning_items %}
  <div class="validation-section warning">
    <strong class="severity-warning">Warnings</strong>
    {% for item in warning_items %}
    <div class="validation-item diagnostic-finding">
      {% if item.constraint_id is defined %}
      <strong>{{ item.constraint_id }}</strong>: {{ item.constraint_name }}
      <br><small>{{ item.message }}</small>
      {% if fix_suggestions.get(item.constraint_id) %}
      <details>
        <summary><small>How to fix</small></summary>
        <p><small>{{ fix_suggestions[item.constraint_id] }}</small></p>
      </details>
      {% endif %}
      {% else %}
      <strong>{{ item.id }}</strong>: {{ item.component_type | capitalize }} discrepancy
      <br><small>{{ item.message }}</small>
      <details>
        <summary><small>How to fix</small></summary>
        <p><small>{{ item.fix_suggestion }}</small></p>
      </details>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if info_items %}
  <div class="validation-section info">
    <strong class="severity-info">Info</strong>
    {% for item in info_items %}
    <div class="validation-item diagnostic-finding">
      {% if item.constraint_id is defined %}
      <strong>{{ item.constraint_id }}</strong>: {{ item.constraint_name }}
      <br><small>{{ item.message }}</small>
      {% if fix_suggestions.get(item.constraint_id) %}
      <details>
        <summary><small>How to fix</small></summary>
        <p><small>{{ fix_suggestions[item.constraint_id] }}</small></p>
      </details>
      {% endif %}
      {% else %}
      <strong>{{ item.id }}</strong>: {{ item.component_type | capitalize }} discrepancy
      <br><small>{{ item.message }}</small>
      <details>
        <summary><small>How to fix</small></summary>
        <p><small>{{ item.fix_suggestion }}</small></p>
      </details>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% elif not report.symptom_relevant %}
  <div style="border-left: 4px solid #2ecc40; padding: 0.5rem 0.75rem;">
    <strong style="color: #2ecc40;">All checks passed</strong>
    <br><small>No issues found in firmware or compatibility validation.</small>
  </div>
  {% endif %}
</article>
