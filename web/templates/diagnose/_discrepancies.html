{# Discrepancy detection results â€” htmx partial #}
{% if discrepancies %}
<article class="diag-report">
  <header class="diag-report-header">
    <div>
      <strong>Hardware Discrepancies Detected</strong>
      <br><span class="diag-report-subtitle">{{ discrepancies | length }} mismatch{{ 'es' if discrepancies | length != 1 }} between FC config and fleet record</span>
    </div>
  </header>

  {% for disc in discrepancies %}
  <div class="diag-finding-card diag-finding-expanded">
    <div class="diag-finding-header">
      <span class="severity-badge-{{ disc.severity.value }}">
        {% if disc.severity.value == 'critical' %}&#10007;{% elif disc.severity.value == 'warning' %}&#9888;{% else %}&#8505;{% endif %}
        {{ disc.severity.value | upper }}
      </span>
      <span class="diag-finding-id">{{ disc.id }}</span>
      <span class="diag-finding-name">{{ disc.component_type | capitalize }}</span>
      {% if disc.category %}
      <span class="diag-category-badge">{{ disc.category }}</span>
      {% endif %}
    </div>
    <div class="diag-finding-body" style="display:block;">
      <p class="diag-finding-message">{{ disc.message }}</p>
      <div class="diag-check-comparison">
        <span class="diag-compare-item"><span class="diag-compare-label">Fleet record:</span> {{ disc.fleet_value }}</span>
        <span class="diag-compare-item"><span class="diag-compare-label">FC config:</span> {{ disc.detected_value }}</span>
      </div>

      <div class="diag-disc-resolution">
        <fieldset>
          <label>
            <input type="radio" name="resolve_{{ disc.id }}" value="update_fleet">
            I swapped the hardware &mdash; update fleet record
          </label>
          <label>
            <input type="radio" name="resolve_{{ disc.id }}" value="flag_config" checked>
            FC is misconfigured &mdash; flag for fixing
          </label>
          <label>
            <input type="radio" name="resolve_{{ disc.id }}" value="ignore">
            Ignore
          </label>
        </fieldset>
      </div>
    </div>
  </div>
  {% endfor %}

  {# Carry state forward for full diagnostic #}
  <form id="full-diag-form">
    <input type="hidden" name="drone_filename" value="{{ drone_filename }}">
    <input type="hidden" name="raw_text" value="{{ raw_text | e }}">
  </form>

  <div class="diag-step-actions">
    <button type="button"
      hx-post="/diagnose/run"
      hx-include="#full-diag-form, #diagnose-form [name='symptoms']"
      hx-target="#diagnostic-results"
      hx-indicator="#diag-spinner">
      Continue to Full Diagnostic
    </button>
    <span id="diag-spinner" class="htmx-indicator" aria-busy="true">Running full diagnostics...</span>
  </div>
</article>
{% else %}
<article class="diag-report">
  <div class="diag-all-clear">
    <span class="diag-all-clear-icon">&#10003;</span>
    <strong>No Discrepancies Found</strong>
    <p>FC config matches the fleet record &mdash; hardware appears unchanged.</p>
  </div>

  {# Carry state forward for full diagnostic #}
  <form id="full-diag-form">
    <input type="hidden" name="drone_filename" value="{{ drone_filename }}">
    <input type="hidden" name="raw_text" value="{{ raw_text | e }}">
  </form>

  <div class="diag-step-actions">
    <button type="button"
      hx-post="/diagnose/run"
      hx-include="#full-diag-form, #diagnose-form [name='symptoms']"
      hx-target="#diagnostic-results"
      hx-indicator="#diag-spinner">
      Continue to Full Diagnostic
    </button>
    <span id="diag-spinner" class="htmx-indicator" aria-busy="true">Running full diagnostics...</span>
  </div>
</article>
{% endif %}
