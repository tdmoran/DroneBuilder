{% extends "base.html" %}
{% block title %}Diagnose — DroneBuilder{% endblock %}

{% block content %}
<div class="diag-page">
  <hgroup>
    <h1>FC Diagnostic</h1>
    <p>Select a drone, load the FC config, describe the issue, and run the scan.</p>
  </hgroup>

  {# ---- Step indicator ---- #}
  <div class="diag-steps" id="step-indicator">
    <div class="diag-step active" data-step="1">
      <span class="diag-step-num">1</span>
      <span class="diag-step-label">Select Drone</span>
    </div>
    <div class="diag-step-divider"></div>
    <div class="diag-step" data-step="2">
      <span class="diag-step-num">2</span>
      <span class="diag-step-label">Load Config</span>
    </div>
    <div class="diag-step-divider"></div>
    <div class="diag-step" data-step="3">
      <span class="diag-step-num">3</span>
      <span class="diag-step-label">Describe Issue</span>
    </div>
    <div class="diag-step-divider"></div>
    <div class="diag-step" data-step="4">
      <span class="diag-step-num">4</span>
      <span class="diag-step-label">Results</span>
    </div>
  </div>

  <form id="diagnose-form">
    {# ================================================================ #}
    {# STEP 1: Select Drone                                             #}
    {# ================================================================ #}
    <article class="diag-panel" id="step-1-panel">
      <header><strong>1. Select Drone</strong></header>
      <select name="drone_filename" id="drone-select" required>
        <option value="">-- Select a fleet drone --</option>
        {% for drone in fleet %}
        <option value="{{ drone.source_file.split('/')[-1].replace('.json', '') }}"
          {% if selected_drone and selected_drone in drone.source_file %}selected{% endif %}>
          {{ drone.name }}{% if drone.nickname %} ({{ drone.nickname }}){% endif %}
          — {{ drone.drone_class }}
        </option>
        {% endfor %}
        <option value="__new_from_config__">+ Create new drone from FC config</option>
      </select>
      <div id="drone-preview"></div>
      <div id="config-drone-preview" style="display:none;"></div>
      <div class="diag-step-actions">
        <button type="button" class="diag-next-btn" id="btn-next-1" disabled onclick="goToStep(2)">
          Next: Load Config
        </button>
      </div>
    </article>

    {# ================================================================ #}
    {# STEP 2: Load FC Config                                           #}
    {# ================================================================ #}
    <article class="diag-panel diag-panel-hidden" id="step-2-panel">
      <header><strong>2. Load FC Config</strong></header>

      <div class="diag-config-options">
        <div class="diag-config-option">
          <h4>Read from FC</h4>
          <p>Connect to your flight controller via USB and read the configuration directly.</p>
          <button type="button" id="btn-read-fc" class="diag-config-btn"
            hx-post="/diagnose/read-config"
            hx-include="#diagnose-form"
            hx-target="#config-status"
            hx-indicator="#config-spinner">
            Connect &amp; Read FC
          </button>
        </div>
        <div class="diag-config-divider">
          <span>or</span>
        </div>
        <div class="diag-config-option">
          <h4>Upload / Paste Config</h4>
          <p>Paste your "diff all" output or upload a saved config file.</p>
          <button type="button" id="btn-upload-toggle" class="diag-config-btn outline"
            onclick="toggleUpload()">
            Paste / Upload
          </button>
        </div>
      </div>

      <div id="upload-area" class="diag-upload-area" style="display: none;">
        <textarea name="raw_text" id="raw-text-input" rows="5"
          placeholder="Paste your 'diff all' output here..."></textarea>
        <div class="diag-upload-controls">
          <label class="diag-file-label">
            <input type="file" name="diff_file" id="diff-file-input" accept=".txt,.log">
            Choose file
          </label>
          <button type="button" class="outline" id="btn-parse-config"
            hx-post="/diagnose/upload-config"
            hx-include="#diagnose-form"
            hx-target="#config-status"
            hx-encoding="multipart/form-data"
            hx-indicator="#config-spinner">
            Parse Config
          </button>
        </div>
      </div>

      <div id="config-status">
        <span id="config-spinner" class="htmx-indicator" aria-busy="true">Reading config...</span>
      </div>

      {# Hidden fields populated by JS after config load #}
      <input type="hidden" name="config_loaded" id="config-loaded" value="">
      <input type="hidden" name="raw_text" id="raw-text-hidden" value="">

      <div class="diag-step-actions">
        <button type="button" class="outline diag-back-btn" onclick="goToStep(1)">Back</button>
        <button type="button" class="diag-next-btn" id="btn-next-2" disabled onclick="goToStep(3)">
          Next: Describe Issue
        </button>
      </div>
    </article>

    {# ================================================================ #}
    {# STEP 3: Describe Issue (optional)                                #}
    {# ================================================================ #}
    <article class="diag-panel diag-panel-hidden" id="step-3-panel">
      <header><strong>3. Describe the Issue</strong> <small>(optional)</small></header>

      <div class="diag-symptom-input-area">
        {# Free-text input with autocomplete #}
        <label for="symptom-text-input">Type your issue in plain language:</label>
        <div class="diag-autocomplete-wrap">
          <input type="text" id="symptom-text-input"
            placeholder='e.g. "my motors won&#39;t spin" or "no video in goggles"'
            autocomplete="off"
            hx-get="/diagnose/match-symptom"
            hx-trigger="keyup changed delay:300ms"
            hx-target="#symptom-suggestions"
            hx-params="*"
            name="q">
          <div id="symptom-suggestions"></div>
        </div>

        <div class="diag-symptom-or">
          <span>or pick from common issues</span>
        </div>

        {# Dropdown selector #}
        <select id="issue-select" onchange="selectDropdownSymptom(this)">
          <option value="">-- Select a common issue --</option>
          {% for key, label in symptoms.items() %}
          <option value="{{ key }}">{{ label }}</option>
          {% endfor %}
        </select>

        {# Selected symptoms display #}
        <div id="selected-symptoms" class="diag-selected-symptoms"></div>
        {# Hidden inputs for selected symptoms (populated by JS) #}
      </div>

      <div class="diag-step-actions">
        <button type="button" class="outline diag-back-btn" onclick="goToStep(2)">Back</button>
        <button type="button" class="diag-next-btn" id="btn-run-scan" onclick="startDiagnostic()">
          Run Diagnostic
        </button>
        <button type="button" class="outline" id="btn-skip-scan" onclick="startDiagnostic()">
          Skip &mdash; Full Scan
        </button>
      </div>
    </article>
  </form>

  {# ================================================================ #}
  {# STEP 4: Results (populated by SocketIO or htmx)                  #}
  {# ================================================================ #}
  <div class="diag-panel diag-panel-hidden" id="step-4-panel">
    <div id="diag-progress-container">
      {# Progress header #}
      <div id="diag-progress-header" class="diag-progress-header" style="display:none;">
        <div class="diag-progress-title">
          <span id="progress-build-name"></span>
          <span id="progress-fc-info" class="diag-fc-badge"></span>
        </div>
        <div id="diag-progress-bar-wrap" class="diag-progress-bar-wrap">
          <div id="diag-progress-bar" class="diag-progress-bar"></div>
        </div>
      </div>

      {# Live check results #}
      <div id="diag-live-checks"></div>

      {# Summary card (shown at end) #}
      <div id="diag-summary" class="diag-summary" style="display:none;"></div>
    </div>

    {# Fallback: htmx-rendered results if SocketIO unavailable #}
    <div id="discrepancy-results"></div>
    <div id="diagnostic-results"></div>

    {# Action buttons after results #}
    <div id="diag-result-actions" class="diag-result-actions" style="display:none;">
      <button type="button" onclick="resetDiagnostic()">Run Again</button>
      <button type="button" class="outline" onclick="exportReport()">Export Report</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/diagnose.js') }}?v=2"></script>
<script>
// Initialize on load — handle pre-selected drone
document.addEventListener('DOMContentLoaded', function() {
  var sel = document.getElementById('drone-select');
  if (sel.value) {
    document.getElementById('btn-next-1').disabled = false;
    // Load drone preview
    fetch('/diagnose/drone-info/' + sel.value)
      .then(function(r) { return r.text(); })
      .then(function(html) {
        document.getElementById('drone-preview').innerHTML = html;
      });
  }
});
</script>
{% endblock %}
